<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Require authentication by default (in .NET Core) - FHI authentication and authorization extensions</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../overrides/readthedocs.css" rel="stylesheet" />
        <link href="../../overrides/cards.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Require authentication by default (in .NET Core)";
        var mkdocs_page_input_path = "api-protection/protecting-endpoints.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../..">
          <img src="../../logo_small.webp" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../concepts/">Consepts and glossary</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../getting-started/">Getting started - Learning and code samples</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../packages/">Overview of packages</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Api protection</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Require authentication by default (in .NET Core)</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#1-add-the-fallback-policy">1: Add the fallback policy</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#2-permit-anonymous-access">2: Permit anonymous access</a>
    </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">End user authentication</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../end-user-authentication/end-user-authentication/">End user authentication</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >How to</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../end-user-authentication/how-to/angular/">Authentication with an Angular + BFF application</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../end-user-authentication/how-to/blazor/">Blazor</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Tutorials</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../end-user-authentication/tutorials/security-middlewares/">Security middlewares</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Token expiration</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../end-user-authentication/tutorials/token-expiration/AuthenticationWithAngularBFF/">Token expiration handling with Angular BFF Client and Downstream APIs</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../end-user-authentication/tutorials/token-expiration/AuthenticationWithBlazorServer/">Token Expiry Handling with Blazor server client and Downstream APIs</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../end-user-authentication/tutorials/token-expiration/token-expiry-downstream-api/">Token Expiry Handling with Downstream APIs</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Server to server authentication</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../server-to-server-authentication/server-to-server/">Server to server (M2M)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >How to</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../server-to-server-authentication/how-to/ClientCredentials/">HttpClient: Client credentials token request(HelseID and EntraID)</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../server-to-server-authentication/how-to/manual-tokenrequest-using-duende/">Manual tokenrequest using duende</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../server-to-server-authentication/how-to/maskinporten-m2m/">HttpClient: Maskinporten token request (JWT-bearer authorization grant)</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Tutorials</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" >ClientCredentials</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../server-to-server-authentication/tutorials/ClientCredentials/Duende-accesstokenmanagement/">Duende AccessTokenManagement library</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">FHI authentication and authorization extensions</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Api protection</li>
      <li class="breadcrumb-item active">Require authentication by default (in .NET Core)</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/FHIDev/Fhi.AuthExtensions/edit/master/docs/api-protection/protecting-endpoints.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="require-authentication-by-default-in-net-core">Require authentication by default (in .NET Core)</h1>
<p>To require authentication by default on all incoming requests, configure a fallback authorization policy in your application's service pipeline. The policy will automatically require users to be authenticated for all endpoints unless explicitly overridden to allow anonymous access. This approach reduces the risk of accidentally exposing sensitive endpoints.</p>
<p>Code samples:</p>
<ul>
<li><a href="https://github.com/FHIDev/Fhi.AuthExtensions/blob/main/samples/Fhi.Samples.AngularBFF/Fhi.Samples.Angular.BFFApi/Program.cs">Angular BFF sample</a></li>
<li><a href="https://github.com/FHIDev/Fhi.AuthExtensions/blob/main/samples/Fhi.Samples.WebApi/HostingExtensions.cs">Web Api</a></li>
</ul>
<h2 id="1-add-the-fallback-policy">1: Add the fallback policy</h2>
<p>All controllers and endpoints require an authenticated user. If a request is made to any endpoint and the user is not authenticated, a 401 Unauthorized response is returned. This is achieved using the <code>SetFallbackPolicy</code> method or <code>FallbackPolicy</code> option in the authorization configuration:</p>
<pre><code>// Option 1: by default
builder.Services.AddAuthorizationBuilder()
    .SetFallbackPolicy(new AuthorizationPolicyBuilder()
        .RequireAuthenticatedUser()
        .Build());

// Or option 2:
builder.Services.AddAuthorization(options =&gt;
{
    options.FallbackPolicy = new AuthorizationPolicyBuilder()
                .RequireAuthenticatedUser()
                .Build();

// Or option 3: for multiple authentication schemes
builder.Services.AddAuthorizationBuilder()
                .SetFallbackPolicy(new AuthorizationPolicyBuilder()
                            .RequireAuthenticatedUser()
                            .Build())
                .AddPolicy(&quot;Scheme1&quot;, policy =&gt;
                {
                    policy.AuthenticationSchemes.Add(&quot;Scheme1&quot;);
                    policy.RequireAuthenticatedUser();
                })
                 .AddPolicy(&quot;Scheme2&quot;, policy =&gt;
                 {
                     policy.AuthenticationSchemes.Add(&quot;Scheme2&quot;);
                     policy.RequireAuthenticatedUser();
                 });

});
</code></pre>
<h2 id="2-permit-anonymous-access">2: Permit anonymous access</h2>
<p>To allow anonymous access to specific endpoints (such as /login, /session, or the SPA fallback) use <code>[AllowAnonymous]</code> or <code>AllowAnonymous()</code> attribute on specific endpoints to permit anonymous access.</p>
<pre><code>// This endpoint allows anonymous access
app.MapGet(&quot;/login&quot;, [AllowAnonymous] async (HttpContext context) =&gt; { ... });

// For an SPA client like Angular should allow anonymous access to the index page
app.MapFallbackToFile(&quot;/index.html&quot;).AllowAnonymous();

</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../../packages/" class="btn btn-neutral float-left" title="Overview of packages"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../end-user-authentication/end-user-authentication/" class="btn btn-neutral float-right" title="End user authentication">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/FHIDev/Fhi.AuthExtensions" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../../packages/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../end-user-authentication/end-user-authentication/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
