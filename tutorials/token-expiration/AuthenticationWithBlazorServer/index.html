<!DOCTYPE html>

<html class="writer-html5" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link href="../../../img/favicon.ico" rel="shortcut icon"/>
<title>Token Expiry Handling with Blazor server client and Downstream APIs - FHI authentication and authorization extensions</title>
<link href="../../../css/theme.css" rel="stylesheet"/>
<link href="../../../css/theme_extra.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" rel="stylesheet"/>
<link href="../../../overrides/readthedocs.css" rel="stylesheet"/>
<link href="../../../overrides/cards.css" rel="stylesheet"/>
<script>
        // Current page data
        var mkdocs_page_name = "Token Expiry Handling with Blazor server client and Downstream APIs";
        var mkdocs_page_input_path = "tutorials/token-expiration/AuthenticationWithBlazorServer.md";
        var mkdocs_page_url = null;
      </script>
<!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
</head>
<body class="wy-body-for-nav" role="document">
<div class="wy-grid-for-nav">
<nav class="wy-nav-side stickynav" data-toggle="wy-nav-shift">
<div class="wy-side-scroll">
<div class="wy-side-nav-search">
<a href="../../..">
<img alt="Logo" class="logo" src="../../../logo_small.webp"/>
</a><div role="search">
<form action="../../../search.html" class="wy-form" id="rtd-search-form" method="get">
<input aria-label="Search docs" name="q" placeholder="Search docs" title="Type search term here" type="text"/>
</form>
</div>
</div>
<div aria-label="Navigation menu" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../..">Home</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../packages/">Overview packages</a>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../concepts/">Concepts and terminology</a>
</li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../protecting-endpoints/">Require authentication by default</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../token-expiry-downstream-api/">Handling token expiration</a>
</li>
<li class="toctree-l1"><a class="reference internal">Server to server communication</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="../../server-to-server/server-to-server/">Overview</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../server-to-server/web-server-host/">Client credentials token request from a Web host</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../server-to-server/manual-token-request/">Manual client credential token request</a>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Code lab</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal">Client credentials flow (server to server)</a>
<ul>
<li class="toctree-l2"><a class="reference internal" href="../../../code-lab/client-credentials/webserver-host-sample/">Using IHttpClientFactory and Duende AccessToken Management</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../code-lab/client-credentials/manual-bearertoken-request/">Bearer token request using shared secret</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../code-lab/client-credentials/manual-bearertoken-request-withclientassertion/">Bearer token request using client assertion</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../code-lab/client-credentials/manual-dpoptoken-request/">DPoP token request</a>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../code-lab/client-credentials/manual-tokenrequest-with-duendeidentitymodel/">Manual token request with Duende IdentityModel</a>
</li>
</ul>
</li>
</ul>
</div>
</div>
</nav>
<section class="wy-nav-content-wrap" data-toggle="wy-nav-shift">
<nav aria-label="Mobile navigation menu" class="wy-nav-top" role="navigation">
<i class="fa fa-bars" data-toggle="wy-nav-top"></i>
<a href="../../..">FHI authentication and authorization extensions</a>
</nav>
<div class="wy-nav-content">
<div class="rst-content"><div aria-label="breadcrumbs navigation" role="navigation">
<ul class="wy-breadcrumbs">
<li><a aria-label="Docs" class="icon icon-home" href="../../.."></a></li>
<li class="breadcrumb-item active">Token Expiry Handling with Blazor server client and Downstream APIs</li>
<li class="wy-breadcrumbs-aside">
<a class="icon icon-github" href="https://github.com/FHIDev/Fhi.AuthExtensions/edit/master/docs/tutorials/token-expiration/AuthenticationWithBlazorServer.md"> Edit on GitHub</a>
</li>
</ul>
<hr/>
</div>
<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div class="section" itemprop="articleBody">
<h1 id="token-expiry-handling-with-blazor-server-client-and-downstream-apis">Token Expiry Handling with Blazor server client and Downstream APIs</h1>
<h2 id="problem">Problem</h2>
<p>In Blazor Server, communication between the browser (client) and the server is managed through SignalR, which maintains a persistent connection using WebSockets (or fallback mechanisms). Blazor Server uses SignalR for all UI interactions and event handling. The SignalR connection does not have access to HttpContext or cookies directly. When a client establishes a connection to the SignalR server it creates <code>HubCallerContext</code> with ConnectionId, User (Claimsprincipal) and Items (properties). </p>
<p>Unlike traditional HTTP requests where cookies are sent with each request, SignalR only sends cookies once, during the initial connection (handshake). After that, no HTTP headers are included in individual method calls over SignalR.</p>
<p>As a result:</p>
<ul>
<li>You cannot access HttpContext.Request.Cookies from inside Blazor components.</li>
<li>You lose access to cookies during the lifetime of the SignalR connection.</li>
<li>HubCallerContext.User is not updated when the authentication cookie is renewed.</li>
</ul>
<p>See <a href="https://learn.microsoft.com/en-us/aspnet/core/blazor/state-management?view=aspnetcore-9.0&amp;pivots=server">Blazor state management</a>
<a href="https://learn.microsoft.com/en-us/aspnet/core/blazor/security/?view=aspnetcore-9.0&amp;tabs=visual-studio#server-side-blazor-authentication">Blazor Server side authentication</a></p>
<h2 id="alternative-solution">Alternative solution</h2>
<h3 id="listen-on-401-from-downstream-api-and-redirect-to-login-site-with-full-reload">Listen on 401 from downstream API and redirect to login site with full reload</h3>
<div class="mermaid">
sequenceDiagram
    participant Browser as Blazor (Browser)
    participant SignalR as SignalR Hub (Blazor Server)
    participant API as API Backend
    participant Auth as IdentityServer (Duende)

    Browser-&gt;&gt;SignalR: Establish connection (via WebSocket)
    SignalR--&gt;&gt;Browser: Connected

    Browser-&gt;&gt;API: HTTP Request (e.g., GET /data)
    API--&gt;&gt;Browser: JSON response

    Note over Browser: Auth cookie may expire...

    Browser-&gt;&gt;API: Another request (after auth expired)
    API--&gt;&gt;Browser: Redirect to IdentityServer

    Browser-&gt;&gt;Auth: OpenID Connect login redirect
    Auth--&gt;&gt;Browser: Token/Cookie issued, redirected back

    Browser-&gt;&gt;SignalR: Reconnect
    SignalR--&gt;&gt;Browser: Reconnected

</div>
</div>
</div><footer>
<hr/>
<div role="contentinfo">
<!-- Copyright etc -->
</div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
</div>
</div>
</section>
</div>
<div aria-label="Versions" class="rst-versions" role="note">
<span class="rst-current-version" data-toggle="rst-current-version">
<span>
<a class="fa fa-github" href="https://github.com/FHIDev/Fhi.AuthExtensions" style="color: #fcfcfc"> GitHub</a>
</span>
</span>
</div>
<script src="../../../js/jquery-3.6.0.min.js"></script>
<script>var base_url = "../../..";</script>
<script src="../../../js/theme_extra.js"></script>
<script src="../../../js/theme.js"></script>
<script src="../../../search/main.js"></script>
<script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
mermaid.initialize({});</script></body>
</html>
